!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).graphqlSse={})}(this,(function(e){"use strict";function t(e){return"object"==typeof e&&null!==e}const n="x-graphql-event-stream-token";function r(e){if("next"!==e&&"complete"!==e)throw new Error(`Invalid stream event "${e}"`);return e}function o(e,t){if(t)try{t=JSON.parse(t)}catch{throw new Error("Invalid stream data")}if("next"===e&&!t)throw new Error('Stream data must be an object for "next" events');return t||null}var a;!function(e){e[e.NewLine=10]="NewLine",e[e.CchunkiageReturn=13]="CchunkiageReturn",e[e.Space=32]="Space",e[e.Colon=58]="Colon"}(a||(a={}));class i extends Error{constructor(e){let n,r;var o;t(o=e)&&"boolean"==typeof o.ok&&"number"==typeof o.status&&"string"==typeof o.statusText?(r=e,n="Server responded with "+e.status+": "+e.statusText):n=e instanceof Error?e.message:String(e),super(n),this.name=this.constructor.name,this.response=r}}async function s(e){const{signal:t,url:n,credentials:s,headers:l,body:c,referrer:d,referrerPolicy:u,fetchFn:f,onMessage:h}=e,w={},y={};let v;try{v=await f(n,{signal:t,method:c?"POST":"GET",credentials:s,referrer:d,referrerPolicy:u,headers:{...l,accept:"text/event-stream"},body:c})}catch(e){throw new i(e)}if(!v.ok)throw new i(v);if(!v.body)throw new Error("Missing response body");let p,b=null;return(async()=>{var e;try{const t=function(){let e,t,n,i=!1,s={event:"",data:""},l=[];const c=new TextDecoder;return function(d){if(void 0===e)e=d,t=0,n=-1;else{const t=new Uint8Array(e.length+d.length);t.set(e),t.set(d,e.length),e=t}const u=e.length;let f=0;for(;t<u;){i&&(e[t]===a.NewLine&&(f=++t),i=!1);let d=-1;for(;t<u&&-1===d;++t)switch(e[t]){case a.Colon:-1===n&&(n=t-f);break;case a.CchunkiageReturn:i=!0;case a.NewLine:d=t}if(-1===d)break;if(f===d){if(s.event||s.data){if(!s.event)throw new Error("Missing message event");const e=r(s.event),t=o(e,s.data);l.push({event:e,data:t}),s={event:"",data:""}}}else if(n>0){const t=e.subarray(f,d),r=c.decode(t.subarray(0,n)),o=n+(t[n+1]===a.Space?2:1),i=c.decode(t.subarray(o));switch(r){case"event":s.event=i;break;case"data":s.data=s.data?s.data+"\n"+i:i}}f=t,n=-1}if(f===u){e=void 0;const t=[...l];return l=[],t}0!==f&&(e=e.subarray(f),t-=f)}}();for await(const n of function(e){if("function"==typeof Object(e)[Symbol.asyncIterator])return e[Symbol.asyncIterator]();return async function*(){const t=e.getReader();let n;do{n=await t.read(),void 0!==n.value&&(yield n.value)}while(!n.done)}()}(v.body)){if("string"==typeof n)throw b=new Error(`Unexpected string chunk "${n}"`);let r;try{r=t(n)}catch(e){throw b=e}if(r)for(const t of r){try{null==h||h(t)}catch(e){throw b=e}const n=t.data&&"id"in t.data?t.data.id:"";switch(n in y||(y[n]=[]),t.event){case"next":n?y[n].push(t.data.payload):y[n].push(t.data);break;case"complete":y[n].push("complete");break;default:throw b=new Error(`Unexpected message event "${t.event}"`)}null===(e=w[n])||void 0===e||e.proceed()}}if(Object.keys(w).length)throw new Error("Connection closed while having active streams")}catch(e){b=!b&&Object.keys(w).length?new i(e):e,null==p||p(b)}finally{Object.values(w).forEach((({proceed:e})=>e()))}})(),{url:n,headers:l,waitForThrow:()=>new Promise(((e,t)=>{if(b)return t(b);p=t})),async*getResults(e){var t;const{signal:n,operationId:r=""}=null!=e?e:{};try{for(;;){for(;null===(t=y[r])||void 0===t?void 0:t.length;){const e=y[r].shift();if("complete"===e)return;yield e}if(b)throw b;if(null==n?void 0:n.aborted)throw new Error("Getting results aborted by the client");await new Promise((e=>{const t=()=>{null==n||n.removeEventListener("abort",t),delete w[r],e()};null==n||n.addEventListener("abort",t),w[r]={proceed:t}}))}}finally{delete y[r]}}}}e.NetworkError=i,e.TOKEN_HEADER_KEY=n,e.TOKEN_QUERY_KEY="token",e.createClient=function(e){const{singleConnection:t=!1,lazy:r=!0,lazyCloseTimeout:o=0,onNonLazyError:a=console.error,generateID:l=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))},retryAttempts:c=5,retry:d=async function(e){let t=1e3;for(let n=0;n<e;n++)t*=2;await new Promise((e=>setTimeout(e,t+Math.floor(2700*Math.random()+300))))},credentials:u="same-origin",referrer:f,referrerPolicy:h,onMessage:w,on:y}=e,v=e.fetchFn||fetch,p=e.abortControllerImpl||AbortController,b=(()=>{let e=!1;const t=[];return{get disposed(){return e},onDispose:n=>e?(setTimeout((()=>n()),0),()=>{}):(t.push(n),()=>{t.splice(t.indexOf(n),1)}),dispose(){if(!e){e=!0;for(const e of[...t])e()}}}})();let g,x,m=0,E=null,S=0;async function C(){try{if(b.disposed)throw new Error("Client has been disposed");return await(null!=x?x:x=(async()=>{var t,r,o;if(E){if(await d(S),g.signal.aborted)throw new Error("Connection aborted by the client");S++}null===(t=null==y?void 0:y.connecting)||void 0===t||t.call(y,!!E),g=new p;const a=b.onDispose((()=>g.abort()));g.signal.addEventListener("abort",(()=>{a(),x=void 0}));const l="function"==typeof e.url?await e.url():e.url;if(g.signal.aborted)throw new Error("Connection aborted by the client");const c="function"==typeof e.headers?await e.headers():null!==(r=e.headers)&&void 0!==r?r:{};if(g.signal.aborted)throw new Error("Connection aborted by the client");let m;try{m=await v(l,{signal:g.signal,method:"PUT",credentials:u,referrer:f,referrerPolicy:h,headers:c})}catch(e){throw new i(e)}if(201!==m.status)throw new i(m);const C=await m.text();c[n]=C;const T=await s({signal:g.signal,headers:c,credentials:u,referrer:f,referrerPolicy:h,url:l,fetchFn:v,onMessage:e=>{var t;null===(t=null==y?void 0:y.message)||void 0===t||t.call(y,e),null==w||w(e)}});return null===(o=null==y?void 0:y.connected)||void 0===o||o.call(y,!!E),T.waitForThrow().catch((()=>x=void 0)),T})())}catch(e){throw x=void 0,e}}function T(n,a,T){if(!t){const t=new p,r=b.onDispose((()=>{r(),t.abort()}));return(async()=>{var r,o,l,p,b;let g=null,x=0;for(;;)try{if(g){if(await d(x),t.signal.aborted)throw new Error("Connection aborted by the client");x++}null===(r=null==y?void 0:y.connecting)||void 0===r||r.call(y,!!g),null===(o=null==T?void 0:T.connecting)||void 0===o||o.call(T,!!g);const i="function"==typeof e.url?await e.url():e.url;if(t.signal.aborted)throw new Error("Connection aborted by the client");const c="function"==typeof e.headers?await e.headers():null!==(l=e.headers)&&void 0!==l?l:{};if(t.signal.aborted)throw new Error("Connection aborted by the client");const{getResults:m}=await s({signal:t.signal,headers:{...c,"content-type":"application/json; charset=utf-8"},credentials:u,referrer:f,referrerPolicy:h,url:i,body:JSON.stringify(n),fetchFn:v,onMessage:e=>{var t,n;null===(t=null==y?void 0:y.message)||void 0===t||t.call(y,e),null===(n=null==T?void 0:T.message)||void 0===n||n.call(T,e),null==w||w(e)}});null===(p=null==y?void 0:y.connected)||void 0===p||p.call(y,!!g),null===(b=null==T?void 0:T.connected)||void 0===b||b.call(T,!!g);for await(const e of m())g=null,x=0,a.next(e);return t.abort()}catch(e){if(t.signal.aborted)return;if(!(e instanceof i))throw e;if(!c||x>=c)throw e;g=e}})().then((()=>a.complete())).catch((e=>a.error(e))),()=>t.abort()}m++;const k=new p,O=b.onDispose((()=>{O(),k.abort()}));return(async()=>{const e=l();n={...n,extensions:{...n.extensions,operationId:e}};let t=null;for(;;){t=null;try{const{url:r,headers:o,getResults:s}=await C();let l;try{l=await v(r,{signal:k.signal,method:"POST",credentials:u,referrer:f,referrerPolicy:h,headers:{...o,"content-type":"application/json; charset=utf-8"},body:JSON.stringify(n)})}catch(e){throw new i(e)}if(202!==l.status)throw new i(l);t=async()=>{let t;try{const n=new p,a=b.onDispose((()=>{a(),n.abort()}));t=await v(r+"?operationId="+e,{signal:n.signal,method:"DELETE",credentials:u,referrer:f,referrerPolicy:h,headers:o})}catch(e){throw new i(e)}if(200!==t.status)throw new i(t)};for await(const t of s({signal:k.signal,operationId:e}))E=null,S=0,a.next(t);return t=null,k.abort()}catch(e){if(k.signal.aborted)return await(null==t?void 0:t());if(!(e instanceof i))throw k.abort(),e;if(r&&(x=void 0),!c||S>=c)throw k.abort(),e;E=e}finally{k.signal.aborted&&0==--m&&(isFinite(o)&&o>0?setTimeout((()=>{m||g.abort()}),o):g.abort())}}})().then((()=>a.complete())).catch((e=>a.error(e))),()=>k.abort()}return t&&!r&&(async()=>{for(m++;;)try{const{waitForThrow:e}=await C();await e()}catch(e){if(b.disposed)return;if(!(e instanceof i))return null==a?void 0:a(e);if(x=void 0,!c||S>=c)return null==a?void 0:a(e);E=e}})(),{subscribe:T,iterate(e,t){const n=[],r={done:!1,error:null,resolve:()=>{}},o=T(e,{next(e){n.push(e),r.resolve()},error(e){r.done=!0,r.error=e,r.resolve()},complete(){r.done=!0,r.resolve()}},t),a=async function*(){for(;;){for(n.length||await new Promise((e=>r.resolve=e));n.length;)yield n.shift();if(r.error)throw r.error;if(r.done)return}}();return a.throw=async e=>(r.done||(r.done=!0,r.error=e,r.resolve()),{done:!0,value:void 0}),a.return=async()=>(o(),{done:!0,value:void 0}),a},dispose(){b.dispose()}}},e.isAsyncGenerator=function(e){return t(e)&&"function"==typeof Object(e)[Symbol.asyncIterator]&&"function"==typeof e.return&&"function"==typeof e.throw&&"function"==typeof e.next},e.isAsyncIterable=function(e){return"function"==typeof Object(e)[Symbol.asyncIterator]},e.parseStreamData=o,e.print=function(e){let t=`event: ${e.event}\ndata:`;return e.data&&(t+=" ",t+=JSON.stringify(e.data)),t+="\n\n",t},e.validateStreamEvent=r}));
